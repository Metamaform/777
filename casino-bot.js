const TelegramBot = require('node-telegram-bot-api');
const fs = require('fs');

// Bot configuration
const BOT_TOKEN = '8496920298:AAEExKqjgCU4WkkzeD7XuEfVLqItJ6NrR3w';
const ORGANIZER_ID = 5698050836;

// Create bot instance
const bot = new TelegramBot(BOT_TOKEN, { polling: true });

// Configuration file for game settings
const CONFIG_FILE = 'bot-config.json';

// Game sessions storage
let gameSessions = {};

// Default configuration
const defaultConfig = {
    isActive: false,
    currentGame: null
};

// Load configuration
let config = defaultConfig;
try {
    if (fs.existsSync(CONFIG_FILE)) {
        config = { ...defaultConfig, ...JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf8')) };
    }
} catch (error) {
    console.log('Using default configuration');
}

// Save configuration
function saveConfig() {
    fs.writeFileSync(CONFIG_FILE, JSON.stringify(config, null, 2));
}

// Casino combinations with display names
const CASINO_COMBINATIONS = {
    '777': {
        name: '7Ô∏è‚É£ 777',
        patterns: ['777', '7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£', '7 7 7', '7Ô∏è‚É£ 7Ô∏è‚É£ 7Ô∏è‚É£']
    },
    'BAR': {
        name: 'üü´ BAR BAR BAR',
        patterns: ['BAR BAR BAR', '–ë–ê–† –ë–ê–† –ë–ê–†', 'üü´üü´üü´', 'üü´ üü´ üü´']
    },
    'VINOGRAD': {
        name: 'üçá –í–ò–ù–û–ì–†–ê–î',
        patterns: ['üçáüçáüçá', '–í–ò–ù–û–ì–†–ê–î –í–ò–ù–û–ì–†–ê–î –í–ò–ù–û–ì–†–ê–î', '–≤–∏–Ω–æ–≥—Ä–∞–¥ –≤–∏–Ω–æ–≥—Ä–∞–¥ –≤–∏–Ω–æ–≥—Ä–∞–¥', 'üçá üçá üçá']
    },
    'LIMON': {
        name: 'üçã –õ–ò–ú–û–ù',
        patterns: ['üçãüçãüçã', '–õ–ò–ú–û–ù –õ–ò–ú–û–ù –õ–ò–ú–û–ù', '–ª–∏–º–æ–Ω –ª–∏–º–æ–Ω –ª–∏–º–æ–Ω', 'LIMON LIMON LIMON', 'üçã üçã üçã']
    }
};

// Check if message contains winning combination
function checkWinningCombination(messageText, gameConfig) {
    if (!messageText || !gameConfig) return null;
    
    const { winningCombination, isSequential, requiredCount } = gameConfig;
    const combination = CASINO_COMBINATIONS[winningCombination];
    
    if (!combination) return null;
    
    let foundCount = 0;
    let lastIndex = -1;
    
    // Count occurrences and check sequence if needed
    for (const pattern of combination.patterns) {
        let searchIndex = 0;
        
        while (true) {
            const index = messageText.indexOf(pattern, searchIndex);
            if (index === -1) break;
            
            if (isSequential) {
                if (index > lastIndex) {
                    foundCount++;
                    lastIndex = index + pattern.length;
                } else {
                    // Reset if not in sequence
                    foundCount = 1;
                    lastIndex = index + pattern.length;
                }
            } else {
                foundCount++;
            }
            
            searchIndex = index + 1;
            
            if (foundCount >= requiredCount) {
                return {
                    combination: winningCombination,
                    count: foundCount,
                    pattern: pattern
                };
            }
        }
    }
    
    return null;
}

// Handle messages
bot.on('message', async (msg) => {
    try {
        const chatId = msg.chat.id;
        const userId = msg.from.id;
        const messageText = msg.text || msg.caption || '';
        
        // Only process if bot is active and game is running
        if (!config.isActive || !config.currentGame) return;
        
        // Check if this is a winning combination
        const winResult = checkWinningCombination(messageText, config.currentGame);
        if (winResult) {
            console.log(`üéâ Winning combination found in chat ${chatId} by user ${userId}`);
            console.log(`Message: ${messageText}`);
            console.log(`Result:`, winResult);
            
            // Send congratulations message
            const winnerName = msg.from.first_name || msg.from.username || '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å';
            const gameConfig = config.currentGame;
            const combinationName = CASINO_COMBINATIONS[gameConfig.winningCombination].name;
            
            const congratsMessage = `üéâüéâüéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! üéâüéâüéâ\n\n` +
                `üèÜ ${winnerName} –≤—ã–∏–≥—Ä–∞–ª!\n\n` +
                `üéØ –í—ã–∏–≥—Ä—ã—à–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è: ${combinationName}\n` +
                `üìä –ù–∞–π–¥–µ–Ω–æ: ${winResult.count} –∏–∑ ${gameConfig.requiredCount}\n` +
                `üîÑ –¢–∏–ø: ${gameConfig.isSequential ? '–ü–æ–¥—Ä—è–¥' : '–ù–µ –ø–æ–¥—Ä—è–¥'}\n\n` +
                `üéä –†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω! üéä`;
            
            await bot.sendMessage(chatId, congratsMessage);
            
            // Stop the game
            config.isActive = false;
            config.currentGame = null;
            saveConfig();
            
            // Wait a moment then close the chat
            setTimeout(async () => {
                try {
                    await bot.leaveChat(chatId);
                    console.log(`‚úÖ Left chat ${chatId} after finding winner`);
                    
                    // Notify organizer
                    await bot.sendMessage(ORGANIZER_ID, 
                        `üéâ –†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n` +
                        `üë§ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winnerName} (ID: ${userId})\n` +
                        `üéØ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${combinationName}\n` +
                        `üìä –ù–∞–π–¥–µ–Ω–æ: ${winResult.count}/${gameConfig.requiredCount}\n` +
                        `üîÑ –¢–∏–ø: ${gameConfig.isSequential ? '–ü–æ–¥—Ä—è–¥' : '–ù–µ –ø–æ–¥—Ä—è–¥'}\n` +
                        `üí¨ –ß–∞—Ç: ${chatId}\n\n` +
                        `‚úÖ –ë–æ—Ç –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç.`
                    );
                } catch (error) {
                    console.error('Error leaving chat:', error.message);
                    await bot.sendMessage(ORGANIZER_ID, 
                        `üéâ –ù–∞–π–¥–µ–Ω –ø–æ–±–µ–¥–∏—Ç–µ–ª—å!\n\n` +
                        `üë§ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winnerName} (ID: ${userId})\n` +
                        `üéØ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${combinationName}\n` +
                        `üí¨ –ß–∞—Ç: ${chatId}\n\n` +
                        `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`
                    );
                }
            }, 3000);
        }
        
    } catch (error) {
        console.error('Error processing message:', error);
    }
});

// Interactive menu functions
function getMainMenu() {
    const gameStatus = config.currentGame ? 
        `üéÆ –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞: ${CASINO_COMBINATIONS[config.currentGame.winningCombination].name}` :
        `üö´ –ò–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞`;
    
    return {
        text: `üé∞ Casino Bot –ú–µ–Ω—é\n\n${gameStatus}\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`,
        reply_markup: {
            inline_keyboard: [
                [{ text: 'üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É', callback_data: 'start_game' }],
                [{ text: 'üìä –°—Ç–∞—Ç—É—Å', callback_data: 'status' }],
                config.currentGame ? 
                    [{ text: '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É', callback_data: 'stop_game' }] :
                    []
            ].filter(row => row.length > 0)
        }
    };
}

function getCombinationMenu() {
    return {
        text: `üéØ –í—ã–±–µ—Ä–∏—Ç–µ –≤—ã–∏–≥—Ä—ã—à–Ω—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é:`,
        reply_markup: {
            inline_keyboard: [
                [{ text: CASINO_COMBINATIONS['777'].name, callback_data: 'combo_777' }],
                [{ text: CASINO_COMBINATIONS['BAR'].name, callback_data: 'combo_BAR' }],
                [{ text: CASINO_COMBINATIONS['VINOGRAD'].name, callback_data: 'combo_VINOGRAD' }],
                [{ text: CASINO_COMBINATIONS['LIMON'].name, callback_data: 'combo_LIMON' }],
                [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', callback_data: 'back_to_main' }]
            ]
        }
    };
}

function getSequenceMenu(combination) {
    return {
        text: `üîÑ –¢–∏–ø –ø–æ–∏—Å–∫–∞ –¥–ª—è ${CASINO_COMBINATIONS[combination].name}:`,
        reply_markup: {
            inline_keyboard: [
                [{ text: 'üîÅ –ü–æ–¥—Ä—è–¥ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)', callback_data: `seq_${combination}_true` }],
                [{ text: 'üîÄ –ù–µ –ø–æ–¥—Ä—è–¥ (–ª—é–±–æ–µ –º–µ—Å—Ç–æ)', callback_data: `seq_${combination}_false` }],
                [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', callback_data: 'back_to_combinations' }]
            ]
        }
    };
}

function getCountMenu(combination, isSequential) {
    return {
        text: `üìä –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π\n\n–ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${CASINO_COMBINATIONS[combination].name}\n–¢–∏–ø: ${isSequential ? 'üîÅ –ü–æ–¥—Ä—è–¥' : 'üîÄ –ù–µ –ø–æ–¥—Ä—è–¥'}\n\n–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10:`,
        reply_markup: {
            inline_keyboard: [
                [
                    { text: '1', callback_data: `count_${combination}_${isSequential}_1` },
                    { text: '2', callback_data: `count_${combination}_${isSequential}_2` },
                    { text: '3', callback_data: `count_${combination}_${isSequential}_3` }
                ],
                [
                    { text: '4', callback_data: `count_${combination}_${isSequential}_4` },
                    { text: '5', callback_data: `count_${combination}_${isSequential}_5` },
                    { text: '6', callback_data: `count_${combination}_${isSequential}_6` }
                ],
                [
                    { text: '7', callback_data: `count_${combination}_${isSequential}_7` },
                    { text: '8', callback_data: `count_${combination}_${isSequential}_8` },
                    { text: '9', callback_data: `count_${combination}_${isSequential}_9` }
                ],
                [
                    { text: '10', callback_data: `count_${combination}_${isSequential}_10` }
                ],
                [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', callback_data: `back_to_sequence_${combination}` }]
            ]
        }
    };
}

// Commands
bot.onText(/\/start/, async (msg) => {
    if (msg.from.id === ORGANIZER_ID) {
        const menu = getMainMenu();
        await bot.sendMessage(msg.chat.id, menu.text, menu);
    }
});

bot.onText(/\/start_game/, async (msg) => {
    if (msg.from.id === ORGANIZER_ID) {
        const menu = getCombinationMenu();
        await bot.sendMessage(msg.chat.id, menu.text, menu);
    }
});

bot.onText(/\/status/, async (msg) => {
    if (msg.from.id === ORGANIZER_ID) {
        let statusText = `üé∞ –°—Ç–∞—Ç—É—Å Casino Bot:\n\n`;
        
        if (config.currentGame) {
            statusText += `üîÑ –°—Ç–∞—Ç—É—Å: ‚úÖ –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞\n`;
            statusText += `üéØ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${CASINO_COMBINATIONS[config.currentGame.winningCombination].name}\n`;
            statusText += `üîÅ –¢–∏–ø: ${config.currentGame.isSequential ? '–ü–æ–¥—Ä—è–¥' : '–ù–µ –ø–æ–¥—Ä—è–¥'}\n`;
            statusText += `üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${config.currentGame.requiredCount}\n`;
        } else {
            statusText += `üîÑ –°—Ç–∞—Ç—É—Å: ‚ùå –ò–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞\n`;
        }
        
        await bot.sendMessage(msg.chat.id, statusText);
    }
});

// Callback query handlers
bot.on('callback_query', async (query) => {
    try {
        const chatId = query.message.chat.id;
        const messageId = query.message.message_id;
        const userId = query.from.id;
        const data = query.data;
        
        // Only organizer can use callbacks
        if (userId !== ORGANIZER_ID) {
            await bot.answerCallbackQuery(query.id, { text: '‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞' });
            return;
        }
        
        if (data === 'start_game') {
            const menu = getCombinationMenu();
            await bot.editMessageText(menu.text, {
                chat_id: chatId,
                message_id: messageId,
                reply_markup: menu.reply_markup
            });
        }
        
        else if (data === 'status') {
            let statusText = `üé∞ –°—Ç–∞—Ç—É—Å Casino Bot:\n\n`;
            
            if (config.currentGame) {
                statusText += `üîÑ –°—Ç–∞—Ç—É—Å: ‚úÖ –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞\n`;
                statusText += `üéØ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${CASINO_COMBINATIONS[config.currentGame.winningCombination].name}\n`;
                statusText += `üîÅ –¢–∏–ø: ${config.currentGame.isSequential ? '–ü–æ–¥—Ä—è–¥' : '–ù–µ –ø–æ–¥—Ä—è–¥'}\n`;
                statusText += `üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${config.currentGame.requiredCount}\n\n`;
                statusText += `üîÑ –ë–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...`;
            } else {
                statusText += `üîÑ –°—Ç–∞—Ç—É—Å: ‚ùå –ò–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞\n\n`;
                statusText += `‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start_game –¥–ª—è –Ω–∞—á–∞–ª–∞`;
            }
            
            await bot.answerCallbackQuery(query.id, { text: statusText, show_alert: true });
        }
        
        else if (data === 'stop_game') {
            config.isActive = false;
            config.currentGame = null;
            saveConfig();
            
            const menu = getMainMenu();
            await bot.editMessageText(menu.text, {
                chat_id: chatId,
                message_id: messageId,
                reply_markup: menu.reply_markup
            });
            
            await bot.answerCallbackQuery(query.id, { text: '‚úÖ –ò–≥—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' });
        }
        
        else if (data === 'back_to_main') {
            const menu = getMainMenu();
            await bot.editMessageText(menu.text, {
                chat_id: chatId,
                message_id: messageId,
                reply_markup: menu.reply_markup
            });
        }
        
        else if (data === 'back_to_combinations') {
            const menu = getCombinationMenu();
            await bot.editMessageText(menu.text, {
                chat_id: chatId,
                message_id: messageId,
                reply_markup: menu.reply_markup
            });
        }
        
        else if (data.startsWith('combo_')) {
            const combination = data.replace('combo_', '');
            const menu = getSequenceMenu(combination);
            await bot.editMessageText(menu.text, {
                chat_id: chatId,
                message_id: messageId,
                reply_markup: menu.reply_markup
            });
        }
        
        else if (data.startsWith('seq_')) {
            const parts = data.split('_');
            const combination = parts[1];
            const isSequential = parts[2] === 'true';
            
            const menu = getCountMenu(combination, isSequential);
            await bot.editMessageText(menu.text, {
                chat_id: chatId,
                message_id: messageId,
                reply_markup: menu.reply_markup
            });
        }
        
        else if (data.startsWith('back_to_sequence_')) {
            const combination = data.replace('back_to_sequence_', '');
            const menu = getSequenceMenu(combination);
            await bot.editMessageText(menu.text, {
                chat_id: chatId,
                message_id: messageId,
                reply_markup: menu.reply_markup
            });
        }
        
        else if (data.startsWith('count_')) {
            const parts = data.split('_');
            const combination = parts[1];
            const isSequential = parts[2] === 'true';
            const requiredCount = parseInt(parts[3]);
            
            // Start the game
            config.currentGame = {
                winningCombination: combination,
                isSequential: isSequential,
                requiredCount: requiredCount
            };
            config.isActive = true;
            saveConfig();
            
            const successText = `‚úÖ –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞!\n\n` +
                `üéØ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${CASINO_COMBINATIONS[combination].name}\n` +
                `üîÅ –¢–∏–ø: ${isSequential ? '–ü–æ–¥—Ä—è–¥' : '–ù–µ –ø–æ–¥—Ä—è–¥'}\n` +
                `üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${requiredCount}\n\n` +
                `üîÑ –ë–æ—Ç –Ω–∞—á–∞–ª –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è...`;
            
            await bot.editMessageText(successText, {
                chat_id: chatId,
                message_id: messageId,
                reply_markup: {
                    inline_keyboard: [
                        [{ text: 'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data: 'back_to_main' }],
                        [{ text: '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É', callback_data: 'stop_game' }]
                    ]
                }
            });
            
            await bot.answerCallbackQuery(query.id, { text: '‚úÖ –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞!' });
            
            console.log(`üé∞ Game started by organizer:`);
            console.log(`‚ñ∂Ô∏è Combination: ${combination}`);
            console.log(`üîÅ Sequential: ${isSequential}`);
            console.log(`üìä Required count: ${requiredCount}`);
        }
        
    } catch (error) {
        console.error('Callback query error:', error);
        await bot.answerCallbackQuery(query.id, { text: '‚ö†Ô∏è –û—à–∏–±–∫–∞' });
    }
});

// Error handling
bot.on('error', (error) => {
    console.error('Bot error:', error);
});

bot.on('polling_error', (error) => {
    console.error('Polling error:', error);
});

console.log('üé∞ Casino Bot –∑–∞–ø—É—â–µ–Ω!');
if (config.currentGame) {
    console.log(`üéÆ –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞: ${CASINO_COMBINATIONS[config.currentGame.winningCombination].name}`);
    console.log(`üîÅ –¢–∏–ø: ${config.currentGame.isSequential ? '–ü–æ–¥—Ä—è–¥' : '–ù–µ –ø–æ–¥—Ä—è–¥'}`);
    console.log(`üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${config.currentGame.requiredCount}`);
} else {
    console.log('üö´ –ò–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start_game –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.');
}
